<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Главная</title>
    <link rel="icon" href="../img/miac_short.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/same.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>

<header id="header" class="header">
    <div class="container header__container">
        <a href="https://spbmiac.ru/" target="_blank" class="logo_top">
            <img class="logo__img" src="../img/miac.png" alt="Логотип">
        </a>
        <nav class="menu_top">
            <ul class="menu__list">
                <li id="UserFIO" class="menu__item"></li>
                <li id="UserGroups" class="menu__item"></li>
                <li><a href="#" id="changePasswordLink">Сменить пароль</a></li>
            </ul>
        </nav>
    </div>
</header>

<div id="changePasswordModal" class="modal-window" style="display: none;" >
    <div class="modal-change">
      <span class="close-button-change" onclick="closeModal()">&times;</span>
      <h2>Смена пароля</h2>
      <input type="password" id="oldPassword" placeholder="Старый пароль">
      <input type="password" id="newPassword" placeholder="Новый пароль">
      <input type="password" id="confirmPassword" placeholder="Подтверждение">
      <button onclick="changePassword()">Сменить пароль</button>
    </div>
  </div>
  
  <script>
    function openModal() {
      var modal = document.getElementById("changePasswordModal");
      modal.style.display = "flex";
  }
    
    // Функция для закрытия модального окна
  function closeModal() {
      var modal = document.getElementById("changePasswordModal");
      modal.style.display = "none";
  }
    
    // Функция для смены пароля
  function changePassword() {
      var oldPassword = document.getElementById("oldPassword").value;
      var newPassword = document.getElementById("newPassword").value;
      var confirmPassword = document.getElementById("confirmPassword").value;
    
      // Проверяем, что новый пароль и подтверждение нового пароля совпадают
    
  if (newPassword !== confirmPassword) {
      alert("New password and confirmation do not match.");
      return;
  }
    
  const url = `${config.ApiUrl}/user_update_password`;
  
  const body = {
        "old_password": "1245",
        "new_password": "123"
  };
    
  const headers = {
        "Content-Type": "application/json",
        "Authorization": token
  };
    
  fetch(url, {
        method: 'PUT',
        headers: {
          'Content-Type':'application/json',
          'Authorization': localStorage.getItem('authToken')
        },
        body: JSON.stringify(data)
  })
        .then(response => response.json())
        .then(data => console.log(data))
        .catch(error => console.error(error));
    
      // Вместо этого мы просто выведем сообщение в консоль
        console.log("Old Password:", oldPassword);
        console.log("New Password:", newPassword);
    
      // Очищаем поля ввода после успешной смены пароля
        document.getElementById("oldPassword").value = "";
        document.getElementById("newPassword").value = "";
        document.getElementById("confirmPassword").value = "";
    
        alert("Password changed successfully!");
        closeModal(); // Закрываем модальное окно после успешной смены пароля
  }
    
    // Привязываем функцию openModal к ссылке
    document.getElementById("changePasswordLink").onclick = function(event) {
      event.preventDefault(); // Предотвращаем переход по ссылке
      openModal();
  };
  </script>

  <h1 class="welcome">Доступ к командам</h1>
  <!-- <p class="welcome-descr">Это главная страница вашего приложения.</p> -->


<aside class="aside_slidebar sidebar">
    <div class="logo">
    </div>
    <ul class="links">
      <!-- <h4>Основные</h4> -->
      <li>
        <span class="material-symbols-outlined">dashboard</span>
        <a href="main.html">Доступ к командам</a>
      </li>
      <li>
        <span class="material-symbols-outlined">person</span>
        <a href="users.html">Пользователи</a>
      </li>
      <li>
        <span class="material-symbols-outlined">pacemaker</span>
        <a href="data.html">Доступ</a>
      </li>
      <hr>
      <!-- <h4>Системные</h4> -->
      <li>
        <span class="material-symbols-outlined">ambient_screen</span>
        <a href="file.html">Файлы</a>
      </li>
      <li>
        <span class="material-symbols-outlined">monitoring</span>
        <a href="directories.html">Директории</a>
      </li>
      <li>
        <span class="material-symbols-outlined">flag</span>
        <a href="commands.html">Команды</a>
      </li>
      <!-- <li>
        <span class="material-symbols-outlined">pacemaker</span>
        <a href="#">Theme Maker</a>
      </li> -->
      <hr>
      <!-- <h4>Личное</h4> -->
      <li>
        <span class="material-symbols-outlined">mail</span>
        <a href="https://mail.ru/?utm_source=portal&utm_medium=logo_portal_navigation&utm_campaign=mail.ru&mt_sub5=142510&mt_sub1=mail.ru&mt_click_id=mt-o4lsx4-1710880334-89398493">Почта</a>
      </li>
      <li class="logout-link">
        <span class="material-symbols-outlined">logout</span>
          <a id="logoutButton" href="#">Выход</a>        
      </li>
    </ul>
  </aside>


<div class="container-card">
    <input type="radio" name="grid" id="grid-2" value="2">
    <input type="radio" name="grid" id="grid-3" value="3">
    <input type="radio" name="grid" id="grid-4" value="4" checked>

    <div class="filterGrid">
        <label for="grid-2"><img src="../img/grid2.png"></label>
        <label for="grid-3"><img src="../img/grid3.png"></label>
        <label for="grid-4"><img src="../img/grid4.png"></label>
    </div>
    <div class="list">
        <div class="item">
            <div class="content-wrapper">
                <div class="title">Максим Матвеев</div>
                <div class="category">- Текст
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>
                  <div class="category">- Текст
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>
                  <div class="category">- Текст
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>

                <button class="addCard">Добавить</button>
            </div>
        </div>

        <div class="item">
            <div class="content-wrapper">
                <div class="title">Никита Алексеев</div>
                <div class="category">- Текст
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>
                  <div class="category">- Текст
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>
                  <div class="category">- Текст
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>

                <button class="addCard">Добавить</button>
            </div>
        </div>

        <div class="item">
            <div class="content-wrapper">
                <div class="title">Игорь Кузнецов</div>
                <div class="category">- Текст
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>
                  <div class="category">- Текст
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>
                  <div class="category">- Текст
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>

                <button class="addCard">Добавить</button>
            </div>
        </div>

        <div class="item">
            <div class="content-wrapper">
                <div class="title" id="title">Данила Миронов</div>
                <div class="category" id="category">- Текст1
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>
                  <div class="category" id="category">- Текст2
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>
                  <div class="category" id="category">- Текст3
                    <button class="delete-button"><img class="trash_bin" src="../img/trash_icon.png" alt="trash_bin"></button>
                  </div>

                <button class="addCard">Добавить</button>
            </div>
        </div>

    </div>
</div>

<script>
    $(document).ready(function() {
        $('.delete-button').on('click', function() {
            // Удаляем родительский элемент .category, который является предшественником кнопки
            $(this).parent().remove();
        });
    });


// Функция для создания карточки
function createCard(user, categories) {
    const card = document.createElement('div');
    card.className = 'item';

    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'content-wrapper';

    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = user;

    const addButton = document.createElement('button');
    addButton.className = 'addCard';
    addButton.textContent = 'Добавить';

    contentWrapper.appendChild(title);

    categories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'category';
        categoryDiv.textContent = `- ${category}`;

        const deleteButton = document.createElement('button');
        deleteButton.className = 'delete-button';

        const trashBinIcon = document.createElement('img');
        trashBinIcon.className = 'trash_bin';
        trashBinIcon.src = '../img/trash_bin_icon.png';
        trashBinIcon.alt = 'trash_bin';

        deleteButton.appendChild(trashBinIcon);
        categoryDiv.appendChild(deleteButton);
        contentWrapper.appendChild(categoryDiv);
    });

    contentWrapper.appendChild(addButton);
    card.appendChild(contentWrapper);

    return card;
}

// Функция для получения данных с сервера и создания карточек
    async function fetchAndCreateCards() {
        fetch(`${config.ApiUrl}/access_get_all`, {
        headers: {
        "Content-Type": "application/json",
        "Authorization": localStorage.getItem('authToken')
        }
    })

    try {
        const response = await fetch(url, { headers });
        const data = await response.json();

        // Предполагается, что data содержит массив объектов, каждый из которых имеет свойства user и categories
        data.forEach(item => {
            const card = createCard(item.user, item.categories);
            document.body.appendChild(card); // Добавляем карточку на страницу
        });
    } catch (error) {
        console.error('Ошибка при получении данных:', error);
    }
}

// Вызываем функцию для создания карточек
fetchAndCreateCards();
    </script>

<div id="modal" class="modal" style="display: none;">
    <div class="modal-content">
        <h2>Новая команда</h2>
        <input type="text" id="inputText" placeholder="Категория">
        <button class="modal-content-add" id="okButton">Добавить</button>
        <button type="button" class="close-button" id="closeModalButton"></button>
    </div>
</div>

<script>
document.querySelector('.addCard').addEventListener('click', function() {
    document.getElementById('modal').style.display = 'block';
});

document.getElementById('okButton').addEventListener('click', function() {
    var inputText = document.getElementById('inputText').value;
    var newCategory = document.createElement('div');
    newCategory.className = 'category';
    newCategory.textContent = '- ' + inputText;
    document.querySelector('.content-wrapper').appendChild(newCategory);
    document.getElementById('modal').style.display = 'none';
    document.getElementById('inputText').value = ''; // Очистка поля ввода после добавления
});
</script>

<script>
    document.getElementById('closeModalButton').addEventListener('click', function() {
    document.getElementById('modal').style.display = 'none';
    });

  // Получаем все элементы с классом category
  var categories = document.getElementsByClassName('category');

  // Добавляем обработчик события наведения мыши на каждый элемент
  for (var i = 0; i < categories.length; i++) {
    categories[i].addEventListener('mouseover', function(event) {
      // Показываем кнопку удаления
      event.currentTarget.querySelector('.delete-button').style.display = 'inline-block';
    });

    // Добавляем обработчик события ухода мыши с элемента
    categories[i].addEventListener('mouseout', function(event) {
      // Скрываем кнопку удаления
      event.currentTarget.querySelector('.delete-button').style.display = 'none';
    });

    // Добавляем обработчик события нажатия на кнопку удаления
    categories[i].querySelector('.delete-button').addEventListener('click', function(event) {
      // Отправляем AJAX-запрос на сервер для удаления категории
      var xhr = new XMLHttpRequest();
      xhr.open('DELETE', '/delete-category', true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          // Удаляем категорию из DOM
          event.currentTarget.parentNode.remove();
        }
      };
      // В запросе должен быть идентификатор категории, который нужно удалить
      xhr.send(JSON.stringify({ id: 'категории_id' }));
    });
  }
</script>
  
<script type="module" src="../js/main.js"></script>
<script type="module" src="../js/logout.js"></script>


</body>
</html>